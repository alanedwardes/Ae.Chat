<html>

<head>
    <meta charset="UTF-8">
    <title>Ae.Chat</title>
</head>

<style>
    form,
    p {
        margin: 0;
    }

    p {
        padding: .5em 0;
    }

    body {
        font-family: sans-serif;
    }

    #audioGainSlider {
        width: 512px;
    }

    .window {
        padding: .5em 1em;
        float: left;
        background: rgba(255, 255, 255, 1);
        box-shadow: rgba(0, 0, 0, 0.1) 0 0 25px;
        margin: 1em .5em;
        border: 2px solid lightskyblue;
    }

    .closeButton {
        float: right;
    }

    .hidden {
        display: none;
    }

    #videoWall {
        position: absolute;
        z-index: -1;
        left: 0;
        top: 0;
    }
</style>

<body>
    <button id="audioControlsButton">🎤 Audio Controls</button>
    <button id="videoControlsButton">📷 Video Controls</button>
    <button id="attendeeWindowButton">🧍 Attendees</button>
    <div style="clear:both"></div>
    <div id="audioControls" class="window hidden">
        <button class="closeButton">X</button>
        <p>🎤 Audio Controls</p>
        <canvas id="volumeCanvas" width="512" height="64"></canvas>
        <form>
            <p><label for="audioGainSlider">Gain: <span id="audioGainValue"></span></label></p>
            <p><input type="range" min="0" max="5" step="0.5" id="audioGainSlider" /></p>
            <p><input type="checkbox" id="localListenCheckbox" /> <label for="localListenCheckbox">Local Listen</label>
            </p>
        </form>
    </div>
    <div id="videoControls" class="window hidden">
        <button class="closeButton">X</button>
        <p>📷 Video Controls</p>
        <form>
            <p><input type="checkbox" id="cameraCheckbox" /> <label for="cameraCheckbox">Enable Video</label></p>
        </form>
    </div>
    <div id="attendeeWindow" class="window hidden">
        <button class="closeButton">X</button>
        <p>🧍 Attendees</p>
        <ol id="attendeeList"></ol>
    </div>
    <canvas id="videoWall"></canvas>
    <script src="dist/bundle.js"></script>
    <script>
        window.onload = function () {
            var roomId = window.location.hash;
            if (roomId == "") {
                function dec2hex(dec) {
                    return ('0' + dec.toString(16)).substr(-2)
                }

                function generateId(len) {
                    var arr = new Uint8Array((len || 40) / 2)
                    window.crypto.getRandomValues(arr)
                    return Array.from(arr, dec2hex).join('')
                }
                roomId = generateId(36);
                window.location.hash = '#' + generateId(36);
            }

            ChatApp.ChatApp.OnConnect = connectionId => {
                let li = document.createElement("li");
                li.onclick = event => {
                    ChatApp.ChatApp.GetStatistics(connectionId).then(statistics => {
                        statistics.forEach(report => {
                            console.log(report);
                        });
                    });
                };
                li.innerHTML = connectionId;
                document.querySelector("#attendeeList").appendChild(li)
            };
            ChatApp.ChatApp.OnDisconnect = connectionId => {
                let list = document.querySelector("#attendeeList");
                for (let i in list.children){
                    let item = list.children[i];
                    if (item.innerHTML == connectionId) {
                        list.removeChild(item);
                    }
                }
            };
            ChatApp.ChatApp.Start(roomId);

            setGainValue(1);

            document.querySelector('#audioGainSlider').addEventListener('input', event => {
                setGainValue(event.srcElement.value);
                ChatApp.ChatApp.SetGain(event.srcElement.value);
            });

            document.querySelector('#localListenCheckbox').addEventListener('input', event => {
                ChatApp.ChatApp.SetLocalListen(event.srcElement.checked);
            });

            document.querySelector('#audioControlsButton').addEventListener('click', event => {
                document.querySelector('#audioControls').classList.remove("hidden");
            });

            document.querySelector('#videoControlsButton').addEventListener('click', event => {
                document.querySelector('#videoControls').classList.remove("hidden");
            });

            document.querySelector('#attendeeWindowButton').addEventListener('click', event => {
                document.querySelector('#attendeeWindow').classList.remove("hidden");
            });

            document.querySelector('#cameraCheckbox').addEventListener('input', event => {
                ChatApp.ChatApp.SetCameraEnabled(event.srcElement.checked);
            });

            function setGainValue(value) {
                document.querySelector('#audioGainSlider').value = value;
                document.querySelector('#audioGainValue').innerHTML = value;
            }

            document.querySelectorAll('.closeButton').forEach(element => {
                element.addEventListener('click', event => {
                    event.srcElement.parentElement.classList.add("hidden");
                });
            });
        };
    </script>
</body>

</html>